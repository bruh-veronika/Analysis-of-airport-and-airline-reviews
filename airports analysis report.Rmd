---
title: 'Анализ данных, сформированных консалтинговой компанией Skytrax на основе пользовательских отзывов на аэропорты'
author: "Пясецкая Вероника, bruh-veronika"
output: html_document
---

## Задача

на основе данных (и поставленных вопросов) постараться выяснить:

* какие проблемы есть в авиаперевозках
* какие улучшения можно предложить на основе выводов по данным

#### Исследуемые вопросы

```{r message = FALSE, warning=FALSE, echo = F}
library(dplyr)
library(ggplot2)
library(lubridate)
library(stringr)

source("~/shared/minor2_2022/1-Intro/hw1/hw1_data.R")

airline = hw1_get_data(df_name = "airline")
airport = hw1_get_data(df_name = "airport")
lounge = hw1_get_data(df_name = "lounge")
seat = hw1_get_data(df_name = "seat")

hw1_get_questions()
```
Все данные преобразованы далее при исследовании каждого из вопросов


### Вопросы

#### Вопрос 1

**Вопрос:** Пишут ли люди более добрые отзывы на аэропорты в выходные?

**Данные:** для ответа на вопрос понадобилась таблица airport

```{r echo = F, message=FALSE, warning=FALSE}
# Работа с датами
#Изменяем тип данных
airport$date = ymd(airport$date) 
airport = airport %>% mutate(weekday=wday(date,label=T)) %>%
  mutate(is_weekend =  (weekday == "Sat" | weekday == "Sun"))
#Проверяем кол-во NA и удаляем ненужное
#sum(is.na(airport$date)) 
#sum(is.na(airport$overall_rating))
airport1 = airport %>% filter(!is.na(overall_rating))
#Смотрим предварительные результаты,находим медианное и среднее зачение
#table(airport1$is_weekend)
median_rating=airport1 %>% group_by(is_weekend) %>% summarise(median_rating=median(overall_rating))
mean_rating=airport1 %>% group_by(is_weekend) %>% summarise(mean_rating=round(mean(overall_rating),2))
airport_mean = airport1 %>% group_by(is_weekend) %>% summarise(mean_rating=mean(overall_rating))
# График Ящик с усами
ggplot(airport1,aes(x = factor(is_weekend), y = overall_rating)) +
  geom_boxplot(fill="light blue")+
  scale_x_discrete(breaks=c(FALSE,TRUE),label=c("Не выходной","Выходной")) + 
  stat_summary(fun=mean, geom='point', shape=20, color="red") +
  xlab("")+
  ylab("Общий рейтинг")+
  ggtitle("Зависимость общего рейтинга\n от момента написания комментария")+
  theme_minimal()
```

**Ответ:** Из графика видно, что несмотря на то, что медианные значения рейтинга в выходные и будние дни совпадают и равны 4, распределение и среднее значение отличаются. В будние дни основная часть оценок варьируется до 7, в то время как в выходной день не привышает 5. Кроме того, среднее значение рейтинга в будние дни выше: в будние она составляет 4.55, а в выходные 4.25. Таким образом разброс верних квартилей в будние и выходные дни составляет 2 пункта, а разница средних значений 0.3 пункта.  Следовательно, люди пишут более "добрые" отзывы на аэропорты в будние, а не в выходные дни.

**Вывод:** С учётом того, что в ходе исследования была выявлена заметная разница в общем "настроении" отзывов, написанных в будние и выходные дни, можно предположить, что существуют сторонние факторы, связанные со временем написания и влияющие на характер отзыва. Возможно, человек решил отложить написание отзыва на свободное время, оставив его уже после посещения аэропорта, снизив тем самым объективность данной им оценки. 
Таким образом, чтобы подтвердить/опровергнуть это предположение, я бы в первую очередь исследовала разницу между датой прилёта и датой написания отзыва. В случае заметного различия между ними, можно будет сделать вывод о частичной необъективности такого отзыва. 
Для получения более чистой картины, стоит предлагать пассажирам поделиться своим мнением непосредственно в сам день прилёта, использовав доступную систему поощрений.


#### Вопрос 2

**Вопрос:** Где доля полётов в экономе выше - в Boeing или Airbus?

**Данные:** для ответа на вопрос понадобились таблицы airline и seat

```{r echo = F, message=FALSE, warning=FALSE}
#Объединяем датасеты и оставляем только нужные столбцы
airline_seat = full_join(airline,seat)
airline_seat = airline_seat %>% select(content,aircraft,cabin_flown)
#Проверяем количество NA в колонке aircraft и видим что их очень много
#sum(is.na(airline_seat$aircraft)) 
#Если в исходной информации у нас NA, то вытаскиваем дополнительную информацию о модели самолёта из отзывов в переменной content
airline_seat = airline_seat %>%
  mutate(aircraft_new=ifelse(!is.na(aircraft),aircraft,ifelse(str_detect(airline_seat$content,"A[0-9][0-9][0-9]|Airbus|AIRBUS|airbus"),"AIRBUS",ifelse(str_detect(airline_seat$content,"Boeing|Boing|BOEING|B[0-9][0-9][0-9]|boeing"),"BOEING",NA))))
#Преобразуем данные к единому виду и чистим от шумов
airline_seat$aircraft_new = airline_seat$aircraft_new %>%
    str_replace_all("A[0-9][0-9][0-9]|Airbus|airbus|A[0-9]","AIRBUS")
airline_seat$aircraft_new = airline_seat$aircraft_new %>%
  str_replace_all("Boeing|Boing|boeing|B[0-9][0-9][0-9]","BOEING")

airline_seat$aircraft_new = airline_seat$aircraft_new %>% str_remove_all("&nbsp|\\-|\\.|\\/|and|[0-9]|[0-9][0-9][0-9]|Embraer ERJ|ER|E |ERJ|CRJ|MD|Dash| Q|Cessna|Unknown|\\,|LR|W|")

airline_seat$aircraft_new = airline_seat$aircraft_new %>% str_remove_all(" ")
airline_seat$aircraft_new = airline_seat$aircraft_new %>% str_remove_all("  ")
#Наблюдения BOEING-BOEING/AIRBUS-AIRBUS,можно свести к BOEING/AIRBUS, ведь это либо результат специфики записи данных и человек на самом деле летел без пересадок, либо один и тот же человек летел с пересадкой. В вопросе мы по сути исследуем привычки уникального пользователя, которые распространяются на оба полёта на одной и той же модели.
#Если в одном наблюдении числится сразу три модели, то вероятней всего это результат специфики записи данных:"AIRBUS A000 BOEING B000" которая по сути обозначает не 3 рейса, а 2
airline_seat$aircraft_new = airline_seat$aircraft_new %>% str_replace_all("BOEINGBOEINGAIRBUS AIRBUS|BOEINGAIRBUSAIRBUS|BOEINGAIRBUSBOEING|BOEINGAIRBUS|AIRBUSBOEING","AIRBUS BOEING")
airline_seat$aircraft_new = airline_seat$aircraft_new %>% 
  str_replace_all("AIRBUSAIRBUS","AIRBUS")
airline_seat$aircraft_new = airline_seat$aircraft_new %>% 
  str_replace_all("BOEINGBOEING","BOEING")
#Удаляем оставшиеся NA
# Для ответа на вопрос нам не нужны наблюдения где есть одновременно и BOEING и AIRBUS, так как при общем подсчёте они друг друга компенсируют.
airline_seat=airline_seat %>% filter(!is.na(aircraft_new))%>% 
  filter(aircraft_new!="")%>% filter(aircraft_new!=" ") %>% filter(aircraft_new!="AIRBUS BOEING")%>% filter(aircraft_new!="BOEINGAIRBUS BOEING")
# Интернет сообщает что World Traveller Plus является особым случаем кабины Premium Economy в Великобритании 
airline_seat=airline_seat %>% 
  mutate(cabin_flown=str_replace_all(cabin_flown,"World Traveller Plus","Premium Economy")) %>% filter(!is.na(cabin_flown))
airline_seat$aircraft_new=factor(airline_seat$aircraft_new)
#table(airline_seat$aircraft_new,airline_seat$cabin_flown)
# График
airline_seat$cabin_flown=factor(airline_seat$cabin_flown,levels=c("First Class","Business Class","Premium Economy","Economy"))
levels(airline_seat$cabin_flown) = c("Первый Класс","Бизнес Класс","Премиум эконом","Эконом")
ggplot(airline_seat) + geom_bar(aes(x=aircraft_new,fill=cabin_flown,stat="identity"),color = "white", alpha = 0.7,position="fill")+
ylab("Количество наблюдений")+
  xlab("Модель самолёта")+
  scale_fill_discrete(name="Тип кабины")+
  ggtitle("Доли полётов в кабинах разного класса\nдля моделей самолётов BOEING и AIRBUS")+
  theme_minimal()+
  scale_y_continuous(labels = scales::percent_format())

```


**Ответ:** Сравнивая доли полётов в кабине Эконом класса по графику мы видим, что различие между двумя моделями практически отсутствует, доля полётов в Экономе у обеих моделей составляет около 70% (AIRBUS=70%,BOEING=72%) от общего количества,разнясь всего на 2%. Однако, если мы считаем полёты совершённые в кабине Премиум Эконома, как Эконом, то становится очевидным, что суммарно такие полёты чаще совершаются в BOEING и составляют в общей сложности 83%  от общего количества, в то время как в AIRBUS общая доля полётов в Экономе не превышает 73%. Таким образом, разница долей составляет 10% в пользу BOEING.

**Вывод:** Из полученного ответа следует, что доля пользователей Эконом класса больше у BOEING, чем у AIRBUS. Если мы выполняем исследование для компаний, производящих эти модели или авиакомпаний, использующих их, то нашей целью является исследовать не только паттерны такого распределения предпочтений, но и их причины. В первом случае стоит уделить особое внимание сравнению таких факторов, как Количество мест в салоне и Планировка схемы рассадки. Во втором случае для получения более цельной картины, следует так же учесть уровень доверия к самой авиакомпании, использующей эти модели, различие цен на рейсы, а так же удобство времени их вылета и прилёта. На основе дальнейших исследований этих зависсимостей можно будет сделать полный вывод о причинах такого распределения.


#### Вопрос 3

**Вопрос:** Какие аэропорты рекомендуют чаще, те, в которых есть лаунжи бизнесс-класса,или те, в которых их нет?

**Данные:** для ответа на вопрос нужны таблицы airport и lounge

```{r echo = F, message=FALSE, warning=FALSE}
#Преобразуем колонки содержащие название аэропортов к единому виду 
#Удаляем неизвестные
lounge=lounge %>% mutate(airport=str_to_lower(airport))
lounge = lounge %>% filter(!is.na(airport))
airport_new = airport %>% mutate(airport=str_replace_all(airport_name,"-"," "))
airport_new = airport_new %>% select(airport,recommended)
#Создаём дополнительные таблицы, разделяя аэрпорты по наличию лаунжа Бизнес класса
loungeB = lounge %>% filter(lounge_type == "Business Class") %>% select(airport,lounge_type) %>% unique()
loungeNotB = lounge %>% filter(lounge_type=="First Class" | lounge_type=="Frequent Flyer" | is.na(lounge_type)) %>% select(airport,lounge_type)
#Обединяем таблицы, заменяем все NA и переименовываем данные
a_l=left_join(airport_new,loungeB)
a_l$lounge_type[is.na(a_l$lounge_type)]="Нет"
a_l$lounge_type = a_l$lounge_type %>%
  str_replace_all("Business Class","Есть")
a_l$recommended=factor(a_l$recommended)
levels(a_l$recommended) = c("Не рекомендован","Рекомендован")
#table(a_l$lounge_type,a_l$recommended)
#График отображающий количество
ggplot(a_l) + geom_bar(aes(x=lounge_type,fill=recommended,stat="identity"),color = "white", alpha = 0.7)+
  ylab("Количество отзывов")+
  xlab("Наличие лаунж зоны Бизнес класса")+
  scale_fill_discrete(name="Рекомендации")+
  ggtitle("Рекомендации аэропортов\nв зависсимости от наличия лаунж зоны Бизнес класса",subtitle="График 1")+
  theme_minimal()

#График отображающий доли
ggplot(a_l) + geom_bar(aes(x=lounge_type,fill=recommended,stat="identity"),color = "white", alpha = 0.7,position="fill")+
  ylab("Процентное соотношение отзывов")+
  xlab("Наличие лаудж зоны Бизнес класса")+
  scale_fill_discrete(name="Рекомендации")+
  ggtitle("Рекомендации аэропортов\nв зависсимости от наличия лаунж зоны Бизнес класса",subtitle="График 2")+
  theme_minimal()+
  scale_y_continuous(labels = scales::percent_format()) 
  
```

**Ответ:** На 1ом графике мы видим, что количество отзывов на аэропорты имеющие и не имеющие лаунж зоны Бизнес класса примерно равно. Таким образом, мы можем сравнить количество рекомендаций на них в процентном соотношении. Из 2ого графика становится очевидным, что чаще рекоммендуют аэропорты в которых есть лаунж зона Бизнес класса (примерно в 30% случаев), в то время как аэропорты без неё рекомендуют лишь около 20% пользователей.

**Вывод:** В общем и целом, мы видим, что аэропорты с лаунж зоной Бизнес класса более предпочтительны среди пассажиров, чем аэропорты без неё.  
Однако, ответ на вопрос не даёт особой практической информации, ведь наличие лаунж зоны Бизнес класса важно в основном для тех, кто ей пользуется (за исключением людей, делающих выводы об аэропорте исключительно по наличию Бизнес лаунжа). Мы же анализируем данные, относящиеся ко всем, не разделённым по этому критерию, посетителям. Таким образом, для предоставления более осмысленного ответа, стоит задать пассажирам дополнительный вопрос: "Посещали ли вы лаунж зону Бизнес класса?" и исследовать новую выборку. В дальнейшем с учётом этого критерия следует изучить связь рекомендаций на саму лаунж зону и рекомендаций на аэропорт, определив кореляцию между двумя этими факторами. 
В зависсимости от цели исследования, я так же рекомендую детально изучить какие именно характеристики лаунж зоны в большей мере повлияли на её оценку и оценку аэропорта в целом, рассчитав их вес.

### Дэшборд

Полученные выводы обобщены в виде дэшборда со следующими элементами 

**Элемент 1:** 
 - вид: график 
 - ответ на вопрос: 1
 - обоснование: Итогом ответа на 1 вопрос стала практическая рекомендация: "Для получения более чистой картины, стоит предлагать пассажирам поделиться своим мнением непосредственно в сам день прилёта, использовав доступную систему поощрений." На мой взгляд важно наглядно продемонстрировать заказчику причину предложенных изменений. Данный бокс плот ясно отображает равенство медианных значений, а так же разброс в рейтинге и средних значениях.(количественная переменная по оси y и категориальная по оси x)
 
**Элемент 2:** 
 - вид: график
 - ответ на вопрос: 2
 - обоснование: Данный бар чарт является уместным инструментом отображения распределения количества пассажиров по классам перелёта (количественная переменная) для различных моделей (категориальная переменная), и что важнее - прироста исследуемых значений между случаями, когда мы учитываем Премиум Эконом в качестве Эконома и когда нет. Важно для уточнения изначального вопроса у заказчика.
 
**Элемент 3:** 
 - вид: число
 - ответ на вопрос: 2
 - обоснование: Данное число показывает принебрежимо малую разницу в распределении перелётов Эконом класса между моделями, если мы учитываем исключительно Эконом 
 
**Элемент 4:** 
 - вид: число
 - ответ на вопрос: 2
 - обоснование: Данное число показывает ощутимую разницу в распределении перелётов Эконом класса между моделями, если мы так же учитываем Премиум Эконом, как Эконом
 
### Общие выводы:

По итогам всей проделанной работы были даны рекомендации по дальнейшим исследованиям, а так же одна практическая рекомендация по 1ому вопросу: Для получения более чистой картины, стоит предлагать пассажирам поделиться своим мнением непосредственно в сам день прилёта, использовав доступную систему поощрений. Выводы по 2ому вопросу приведены в ДэшБорде и требуют уточнения у заказчика. 

В дополнение, могу сделать вывод, что полученные результаты искажаются многими факторами, такими как расслоение людей, оставивших тот или иной отзыв, по социальным и экономическим группам. Например, ответ на второй вопрос свидетельствует о том, что в основном люди путешествуют Эконом классом, что уже делает результаты полученные в третьем неполноценными. Ведь человек путешествующий эконом классом с меньшей вероятностью посетит лаунж зону бизнес класса, чем пассажир бизнес класса, а расценивать их мнение на равне будет необъективно.
В качестве способа уменьшить искажение можно исследовать более узкие выборки на большее количество закономерностей и влияющих на результат переменных. 

